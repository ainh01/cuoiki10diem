name: API DataTruyen CI/CD  

on:  
  push:  
    branches: [ main ]  
    paths:  
      - 'Services/api_datatruyen/**'  
  pull_request:  
    branches: [ main ]  
    paths:  
      - 'Services/api_datatruyen/**'  

jobs:  
  build-and-push:  
    runs-on: ubuntu-latest  
    
    steps:  
    - name: Checkout code  
      uses: actions/checkout@v4  

    - name: Set up Python  
      uses: actions/setup-python@v5  
      with:  
        python-version: '3.11'  

    - name: Install dependencies & lint  
      working-directory: ./Services/api_datatruyen  
      run: |  
        python -m pip install --upgrade pip  
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi  
        pip install flake8  
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true  

    - name: Log in to ACR  
      uses: docker/login-action@v3  
      with:  
        registry: ${{ secrets.ACR_SERVER }}  
        username: ${{ secrets.ACR_USERNAME }}  
        password: ${{ secrets.ACR_PASSWORD }}  

    - name: Build and push Docker image  
      working-directory: ./Services/api_datatruyen  
      run: |  
        docker build -t ${{ secrets.ACR_SERVER }}/api-datatruyen:${{ github.sha }} .  
        docker tag ${{ secrets.ACR_SERVER }}/api-datatruyen:${{ github.sha }} ${{ secrets.ACR_SERVER }}/api-datatruyen:latest  
        docker push ${{ secrets.ACR_SERVER }}/api-datatruyen:${{ github.sha }}  
        docker push ${{ secrets.ACR_SERVER }}/api-datatruyen:latest  
